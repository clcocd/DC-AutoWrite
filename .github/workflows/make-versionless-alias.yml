name: make-versionless-alias

on:
  release:
    types: [published]        # 새 릴리스 publish 시 자동 실행
  workflow_dispatch:          # 수동 실행도 지원
    inputs:
      version:
        description: "수동 실행 시 쓸 버전 (예: 1.0.0). 비워두면 최신 릴리스 태그 사용."
        required: false
        type: string

permissions:
  contents: write

jobs:
  alias:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Decide tag
        id: vars
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        shell: bash
        run: |
          set -euo pipefail

          # release 이벤트면 그 태그를 사용
          if [[ -n "${RELEASE_TAG:-}" ]]; then
            TAG="$RELEASE_TAG"
          # 수동 실행이면 입력 태그 우선
          elif [[ -n "${INPUT_TAG:-}" ]]; then
            TAG="$INPUT_TAG"
          # 둘 다 없으면 최신 릴리즈 태그 조회
          else
            TAG="$(gh release view --json tagName -q .tagName)"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using tag: $TAG"

      - name: Download versioned assets from the release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p work
          cd work

          gh release download "$TAG" \
            --pattern "*mac*aarch64*.zip"
          ls -la

          AARCH64_ZIP="$(ls -1 *mac*aarch64*.zip | head -n 1)"

          if [[ -z "${AARCH64_ZIP:-}"]]; then
            echo "필요한 mac zip을 못 찾았어요. 패턴/파일명을 확인하세요."
            exit 1
          fi

          cp -f "$AARCH64_ZIP" dcautowrite-mac-aarch64.zip

          ls -la

      - name: Upload alias assets back to the same release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          set -euo pipefail
          gh release upload "$TAG" \
            work/dcautowrite-mac-aarch64.zip \
            --clobber
