name: make-versionless-alias

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "대상 릴리즈 태그 (예: v1.0.0). 비우면 latest 릴리즈 사용"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  alias:
    runs-on: ubuntu-latest

    # ✅ 여기서 repo를 고정으로 전달 (owner/repo 형태)
    env:
      GH_REPO: ${{ github.repository }}

    steps:
      - name: Decide tag
        id: vars
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${RELEASE_TAG:-}" ]]; then
            TAG="$RELEASE_TAG"
          elif [[ -n "${INPUT_TAG:-}" ]]; then
            TAG="$INPUT_TAG"
          else
            # ✅ repo를 명시했으니 .git 없어도 OK
            TAG="$(gh release view --repo "$GH_REPO" --json tagName -q .tagName)"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using tag: $TAG"

      - name: Download versioned assets from the release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.vars.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p work
          cd work

          # ✅ repo를 명시
          gh release download "$TAG" --repo "$GH_REPO" \
            --pattern "*mac*aarch64*.zip"

          ls -la

          AARCH64_ZIP="$(ls -1 *mac*aarch64*.zip | head -n 1)"

          if [[ -z "${AARCH64_ZIP:-}"]]; then
            echo "필요한 mac zip을 못 찾았어요. 패턴/파일명을 확인하세요."
            exit 1
          fi

          cp -f "$AARCH64_ZIP" dcautowrite-mac-aarch64.zip

      - name: Upload alias assets back to the same release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.vars.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail

          # ✅ repo를 명시
          gh release upload "$TAG" --repo "$GH_REPO" \
            work/dcautowrite-mac-aarch64.zip \
            --clobber
